# Simulation 2 – DNS Tunneling  
## Issues & Resolutions

---

### ***Issue 1: DNS Tunneling Traffic Visible at Sensor Level but No Detection Triggered***

**Description:**  
During the DNS tunneling simulation, suspicious DNS traffic was successfully generated and observed at the network sensor level using packet inspection tools and Security Onion. However, no alerts or detections were triggered initially in the SIEM or IDS dashboards.

**Impact:**  
- DNS tunneling activity was not automatically detected  
- Validation appeared incomplete despite confirmed traffic  
- Analysis relied on manual inspection rather than alerting  
- Detection effectiveness could not be confirmed  

**Root Cause:**  
The issue occurred because network **visibility existed without detection logic**, caused by one or more of the following:
- Suricata DNS tunneling rules not enabled or not tuned  
- Zeek DNS logs generated but not mapped to alerts  
- DNS logs not ingested or parsed correctly in Splunk  
- Detection thresholds not met by the simulated traffic  
- Simulation intentionally designed to demonstrate sensor visibility before detection engineering  

**Resolution:**  
1. Confirmed DNS tunneling traffic using packet-level inspection tools.  
2. Verified Zeek DNS logs were being generated correctly.  
3. Confirmed Suricata was running and processing DNS traffic.  
4. Reviewed existing IDS rules and SIEM searches related to DNS tunneling.  
5. Established sensor-level visibility as a baseline before detection tuning.

**Validation:**  
DNS tunneling activity was successfully confirmed at the network sensor level. This validated proper sensor placement and log generation, providing a foundation for future detection engineering and alert development.

---

### ***Issue 2: DNS Tunneling Queries Appeared Legitimate and Did Not Trigger Detection***

**Description:**  
During the DNS tunneling simulation, DNS queries were successfully generated and captured by network sensors; however, the queries did not initially appear malicious. The traffic resembled legitimate DNS requests and blended into normal DNS activity, making it difficult to distinguish tunneling behavior through simple inspection or default alerts.

**Impact:**  
- No immediate alerts were triggered by IDS or SIEM  
- DNS tunneling activity blended into baseline DNS traffic  
- Manual inspection was required to identify suspicious characteristics  
- Detection logic required deeper analysis beyond basic signatures  

**Root Cause:**  
DNS tunneling is designed to evade detection by:
- Encoding data within subdomains that appear syntactically valid  
- Using legitimate DNS request formats  
- Maintaining normal query timing and volume  
- Avoiding obvious indicators such as malformed packets or known malicious domains  

Default IDS rules and basic SIEM searches often fail to flag this behavior without additional tuning.

**Resolution:**  
1. Reviewed DNS query characteristics for tunneling indicators, including:
   - Excessively long subdomain strings  
   - High entropy or random-looking domain names  
   - Repeated queries to the same domain  
2. Analyzed Zeek DNS logs to identify anomalies in query length and frequency.  
3. Used packet-level inspection to confirm encoded data within DNS requests.  
4. Identified the need for custom detection logic rather than relying solely on default signatures.

**Validation:**  
DNS tunneling behavior was successfully confirmed through manual analysis and sensor visibility. This validated the presence of tunneling activity and highlighted the need for custom or heuristic-based detection rules.

---

### ***Issue 3: DNS Logs Present but Not Properly Parsed or Searchable in Splunk***

**Description:**  
During the DNS tunneling simulation, DNS-related logs were confirmed to be generated by network sensors (Zeek and/or Suricata). However, when searching in Splunk, the DNS data was difficult to locate or not easily searchable due to missing, inconsistent, or unclear field extractions.

**Impact:**  
- DNS tunneling indicators were not easily searchable in Splunk  
- Detection logic could not reliably reference DNS fields such as query name, query length, or frequency  
- Manual packet or Zeek log review was required instead of SIEM-based analysis  
- Slowed validation of DNS tunneling behavior  

**Root Cause:**  
The issue was caused by incomplete or inconsistent parsing of DNS logs in Splunk, including:
- DNS logs being ingested as raw text without proper field extraction  
- Incorrect or unexpected sourcetypes for Zeek or Suricata DNS logs  
- Lack of DNS-specific CIM mapping  
- Fields such as `query`, `qtype`, or `dns_query` not being extracted automatically  

As a result, DNS telemetry existed but was not normalized for effective analysis.

**Resolution:**  
1. Identified the correct Splunk sourcetypes associated with DNS logs.  
2. Inspected raw events to confirm DNS data was present.  
3. Used Splunk field discovery to identify available DNS-related fields.  
4. Adjusted searches to reference raw fields when normalized fields were unavailable.  
5. Documented the need for custom field extractions or CIM mapping for DNS data.

**Validation:**  
After confirming the presence of DNS data and identifying usable fields, DNS tunneling activity could be queried and analyzed in Splunk. This enabled further detection tuning and correlation efforts.

---

### ***Issue 4: Detection Thresholds and Heuristics Not Tuned to Flag DNS Tunneling Activity***

**Description:**  
After confirming that DNS logs were present and searchable in Splunk, no alerts were triggered for the DNS tunneling simulation. Although the activity exhibited tunneling characteristics, existing detection logic and thresholds were not sensitive enough to flag the behavior as suspicious.

**Impact:**  
- DNS tunneling activity went undetected by automated alerts  
- SIEM dashboards did not surface the activity without manual analysis  
- Detection validation remained incomplete  
- Additional analyst effort was required to identify tunneling behavior  

**Root Cause:**  
DNS tunneling detection often requires **behavioral and heuristic-based thresholds**, which were not yet tuned for this environment. Contributing factors included:
- Thresholds for DNS query length, frequency, or entropy set too high  
- Lack of baselined “normal” DNS behavior for comparison  
- Reliance on default rules that do not account for subtle tunneling techniques  
- No correlation across multiple DNS indicators (length + frequency + repetition)  

As a result, the tunneling traffic blended into normal DNS patterns.

**Resolution:**  
1. Reviewed DNS tunneling indicators commonly associated with exfiltration, including:
   - Unusually long DNS query names  
   - Repeated queries to a single domain  
   - High-entropy subdomains  
2. Adjusted detection logic to focus on behavioral patterns rather than single events.  
3. Lowered detection thresholds in test queries to surface suspicious DNS activity.  
4. Documented tuning requirements and detection gaps for future refinement.  

**Validation:**  
After adjusting detection thresholds and analysis logic, suspicious DNS query patterns consistent with tunneling behavior could be identified. This confirmed that detection effectiveness depended on proper tuning rather than sensor visibility alone.

---

### ***Issue 5: Lack of Correlation Between DNS Indicators Prevented Alert Generation***

**Description:**  
Even after identifying suspicious DNS characteristics (such as long query names and repeated requests), no single indicator alone was sufficient to trigger an alert. DNS tunneling behavior required correlation across multiple data points, which was not initially implemented.

**Impact:**  
- DNS tunneling activity did not escalate into an alert  
- Indicators remained isolated and required manual analysis  
- SIEM dashboards did not surface high-confidence detections  
- Detection validation was incomplete without correlated evidence  

**Root Cause:**  
DNS tunneling detection is rarely based on a single event. The absence of correlation logic meant:
- Long DNS queries were not correlated with high query frequency  
- Repeated queries were not evaluated for entropy or structure  
- Network indicators were not combined into a single risk signal  
- SIEM searches evaluated events in isolation rather than as patterns over time  

Without correlation, tunneling behavior appeared as low-risk noise.

**Resolution:**  
1. Identified key DNS tunneling indicators suitable for correlation, including:
   - Query length  
   - Query frequency per host  
   - Repeated domain usage  
   - High-entropy subdomains  
2. Designed detection logic to evaluate multiple indicators within a defined time window.  
3. Documented correlation requirements for future alert development and dashboards.  
4. Established correlation as a necessary step beyond basic visibility and parsing.  

**Validation:**  
When DNS indicators were evaluated together rather than individually, tunneling behavior could be identified with higher confidence. This confirmed that effective DNS tunneling detection depends on multi-factor correlation rather than single-event alerts.

---

